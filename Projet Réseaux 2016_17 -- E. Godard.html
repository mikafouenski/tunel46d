<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0069)http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/ -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>Projet Réseaux 2016/17 -- 	E. Godard</title>
    <meta name="generator" content="http://txt2tags.sf.net">
    <link rel="stylesheet" href="./Projet Réseaux 2016_17 -- E. Godard_files/2colonnes.css" type="text/css" media="screen">
    <link rel="stylesheet" href="./Projet Réseaux 2016_17 -- E. Godard_files/bleucmi.css" type="text/css" media="screen">
    <link rel="stylesheet" href="./Projet Réseaux 2016_17 -- E. Godard_files/2colonnes-print.css" type="text/css" media="print">
  <style>@media print {#ghostery-purple-box {display:none !important}}</style></head>
  <body bgcolor="white" text="black">
    <div id="logo">
      <p>
	<a href="http://www.univ-amu.fr/">
	  <img alt="	Université Aix-Marseille" title="	Université Aix-Marseille" src="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/logo.svg" align="left" style="width:100%;border: 0px;">
	</a>
      </p>
    </div>
    <div id="titre"> Projet Réseaux 2016/17  </div>
    
    <div id="barre">
      <div class="nav">
        
<ul>
<li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/">Accueil</a>
</li>
<li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens">Enseignement</a>
  <ul>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux">M1 Réseaux</a>
  </li>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/secu">M2 Sécurité</a>
  </li>
  </ul>
</li>
<li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/rech/">Recherche</a>
<p></p>
</li>
</ul>

<!-- xhtml code generated by txt2tags 2.6. (http://txt2tags.org) -->
<!-- cmdline: txt2tags -T 2colonnes.html -t xhtml -o cmi.template.htm cmi.template.t2t -->
      </div>
    </div>
    
    <div id="main" class="main"> 
      <p></p>
<hr class="light">
<p></p>

  <ul>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc1">Mode Opératoire</a>
    <ul>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc2">0.1. Livrables</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc3">0.2. Présentation du code</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc4">0.3. Rendu</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#soutenance">0.4. Soutenance</a>
    </li>
    </ul>
  </li>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#init">1. Configuration Réseau</a>
    <ul>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc7">1.1. Topologie et Adressage</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#reseau">1.2. Un grand malheur !</a>
    </li>
    </ul>
  </li>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#tun">2. L'interface virtuelle TUN</a>
    <ul>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc10">2.1. Création de l'interface</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc11">2.2. Configuration de l'interface</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc12">2.3. Récupération des paquets</a>
    </li>
    </ul>
  </li>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#ipv4">3. Un tunnel simple pour IPv4</a>
    <ul>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc14">3.1. Redirection du trafic entrant</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc15">3.2. Redirection du trafic sortant</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc16">3.3. Intégration Finale du Tunnel</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc17">3.4. Mise en place du tunnel entre VM1-6 et VM3-6 : Schémas</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc18">3.5. Mise en place du tunnel entre VM1 et VM3 : Système</a>
    </li>
    </ul>
  </li>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc19">4. Validation Fonctionnelle</a>
    <ul>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc20">4.1. Configuration</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc21">4.2. Couche 3</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc22">4.3. Couche 4</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc23">4.4. Couche 4 : bande passante</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc24">4.5. Couche 4 : facultatif</a>
    </li>
    </ul>
  </li>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc25">5. Améliorations</a>
    <ul>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc26">5.1. Configuration <tt>ansible</tt></a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc27">5.2. Une amélioration simple</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc28">5.3. Fragmentation et Réassemblage</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc29">5.4. Tunnels entre VMs</a>
    </li>
    </ul>
  </li>
  <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc30">6. FAQ</a>
    <ul>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc31">6.1. Comment ouvrir un shell en root ?</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc32">6.2. Le JRE est différent entre la machine hôte et la VM</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#java">6.3. Java, ce n'est pas la fête pour les appels système</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc34">6.4. On n'a pas encore vu de serveur en java</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc35">6.5. Les interfaces TUN n'apparaissent pas dans l'interface graphique</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc36">6.6. Comment envoyer un seul paquet ICMP avec <tt>ping</tt> ?</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc37">6.7. Les paquets lus sur <tt>tun0</tt> sont incomplets ?</a>
    </li>
    <li><a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#toc38">6.8. J'ai mis en place la redirection de ports sur <tt>virtualbox</tt> mais le <tt>ping/ping6</tt> ne fonctionne pas ?</a>
    </li>
    </ul>
  </li>
  </ul>

<p></p>
<hr class="light">
<p></p>
<p>
Nous sommes dans le futur, la transition avec IPv6 est terminé, ne
subsiste que quelques machines encore en IPv4 seulement.  Le but de ce
projet est de permettre des communications entre îlots IPv4 au sein
d'un monde IPv6. Dans une première partie, on utilisera des tunnels
simples au-dessus de IPv6.
</p>

<h1 id="toc1">Mode Opératoire</h1>

<p>
Le projet se déroule <b>en binôme ou trinôme</b>
sur l'ensemble des séances de TP restantes plus
une soutenance le <b>mercredi 7 décembre</b>.
Vous devrez respecter l'ensemble des instructions données dans ce
sujet ainsi que les dates de rendu des livrables. 
</p>

<h2 id="toc2">0.1. Livrables</h2>

<p>
Vos livrables contiendront une archive sous forme <code>zip</code> 
 ainsi qu'un fichier <code>pdf</code> décrivant votre travail et répondant aux questions
du sujet.
</p>
<p>
<b>Dates :</b>
</p>

<ul>
<li>Jeudi 24 novembre 18h: inscription des binômes/trinômes sur 
  <a href="https://ametice.univ-amu.fr/mod/wiki/view.php?id=506125">AMETICE</a>
</li>
<li>Vendredi 25 novembre 19h : livrable intermédiaire,
correspondant au minimum à la partie <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#tun">1</a> et aux premières parties de la partie 2 (en fonction de votre groupe) 
  à déposer
  <a href="https://ametice.univ-amu.fr/mod/assign/view.php?id=506126">ici</a>
</li>
<li>Mercredi 7 décembre: livrable final, à déposer avant 18h00 (aucun dépôt ultérieure possible)
  <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/FIXME">ici</a>
</li>
<li>Soutenance : <u>mercredi 7 décembre 14h-18h</u>
</li>
</ul>

<h2 id="toc3">0.2. Présentation du code</h2>

<p>
Le choix du langage est libre (parmi C,java,python)
même si C ou python sont sans doute plus avantageux
étant donnée l'utilisation des appels systèmes.
Voir la <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#java">FAQ</a>, si vous souhaitez utiliser java.
</p>
<p>
Une attention particulière sera portée à la lisibilité du code, les
commentaires sont indispensables. Un soin particulier sera porté à la
modularité du code.
Par exemple, en C, pour chaque partie on écrira un (ou
plusieurs) fichiers <code>.h</code> et <code>.c</code> correspondant. L'exécutable
principal pour tester la bibliothèque <code>bibli</code> (correspondant à
<code>bibli.c</code> et <code>bibli.h</code> ) se nommera <code>test_bibli</code> sauf
instructions explicites.
</p>
<p>
Un makefile permettra de compiler le code. En outre, pour chaque test
de bibliothèque, une cible <code>tester_bibli</code> sera ajouté qui lancera le
programme <code>test_bibli</code> une ou plusieurs fois avec des paramètres
adéquats. 
</p>

<h2 id="toc4">0.3. Rendu</h2>

<p>
Le rendu s'effectuera sur 
l'<a href="https://ametice.univ-amu.fr/course/view.php?id=24260">ENT</a>.
</p>
<p>
Notez que vous pouvez rendre
plusieurs versions de votre projet tant que vous ne validez pas
définitivement. 
</p>
<p>
<u><b>Aucun</b> fichier ne sera accepté par courriel.</u>
</p>

<h2 id="soutenance">0.4. Soutenance</h2>

<p>
La soutenance consiste à une <b>démonstration</b> de votre système. 
Vous avez 10 minutes de présentation + 5 minutes de questions. 
La présentation pourra suivre l'ordre des parties de l'énoncé et des tests associés.
Il n'est pas demandé de présenter votre code 
(celui-ci sera évalué ultérieurement) mais plutôt le fonctionnement des tunnels.
Pensez à préparer des fichiers de configuration ou des scripts 
permettant de montrer plusieurs scénarios (avec autant de VMs que nécessaire)
en <u>temps limité</u>. 
</p>

<h1 id="init">1. Configuration Réseau</h1>

<p>
On commence par mettre en place le réseau qui servira à déployer notre système. 
</p>

<h2 id="toc7">1.1. Topologie et Adressage</h2>

<p>
<img align="middle" src="./Projet Réseaux 2016_17 -- E. Godard_files/reseau.png" border="0" alt="">
</p>
<p>
Vous utiliserez vos 6 machines virtuelles avec le plan d'adressage suivant
</p>

<table border="1" cellpadding="4">
<tbody><tr>
<th></th>
<th>LAN1</th>
<th>LAN2</th>
<th>LAN3</th>
<th>LAN4</th>
<th>LAN1-6</th>
<th>LAN2-6</th>
</tr>
<tr>
<td>réseau</td>
<td align="center">172.16.2.128/28</td>
<td align="center">172.16.2.160/28</td>
<td align="center">172.16.2.144/28</td>
<td align="center">172.16.2.176/28</td>
<td align="center">fc00:1234:1::/64</td>
<td align="center">fc00:1234:2::/64</td>
</tr>
<tr>
<td>VM1</td>
<td align="center">172.16.2.131</td>
<td></td>
<td align="center">172.16.2.151</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>VM2</td>
<td align="center">172.16.2.132</td>
<td align="center">172.16.2.162</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>VM3</td>
<td></td>
<td align="center">172.16.2.163</td>
<td></td>
<td align="center">172.16.2.183</td>
<td></td>
<td></td>
</tr>
<tr>
<td>VM1-6</td>
<td></td>
<td></td>
<td align="center">172.16.2.156</td>
<td></td>
<td align="center"><i>auto</i></td>
<td></td>
</tr>
<tr>
<td>VM2-6</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td align="center">fc00:1234:1::26</td>
<td align="center">fc00:1234:2::26</td>
</tr>
<tr>
<td>VM3-6</td>
<td></td>
<td></td>
<td></td>
<td align="center">172.16.2.186</td>
<td></td>
<td align="center"><i>auto</i></td>
</tr>
</tbody></table>

<p>
Si l'on ne souhaite pas utiliser l'auto-configuration IPv6, on pourra
utiliser fc00:1234:1::16 pour VM1-6 dans LAN1-6
et fc00:1234:2::36 pour VM3-6 dans LAN2-6.
</p>

<ol>
<li>Mettre en place les  6 VMs
</li>
</ol>

<p>
Préparer les fichiers <code>Vagrantfile</code> et <code>ansible</code> de votre système.
<u>Vérifier que tout fonctionne bien en partant de machines neuves</u>.
</p>
<p>
Il est conseillé de bien organiser votre travail : un gestionnaire de
versions comme <code>git</code> est <u>indispensable</u>.
</p>

<h2 id="reseau">1.2. Un grand malheur !</h2>

<p>
La machine VM2 s'est arrêtée ! VM1 n'a donc plus accès directement à
VM3.
</p>
<p>
<img align="middle" src="./Projet Réseaux 2016_17 -- E. Godard_files/reseau-tun.png" border="0" alt="">
</p>
<p>
Comment pourrait-on faire ?
Nous allons relier nos deux îlots IPv4 via le réseau IPv6...
</p>

<h1 id="tun">2. L'interface virtuelle TUN</h1>

<p>
Afin de pouvoir injecter le trafic dans un tunnel, nous devons
récupérer le trafic depuis l'espace noyau pour le mettre en espace
utilisateur. Pour ceci, Linux offre la possibilité de créer des
<i>interfaces réseaux virtuelles</i> TUN.
Les paramètres réseau de ces interfaces pourront être configurées
comme n'importe quelle interface.
<u>Vous devrez être root (via <code>sudo</code>) pour pouvoir créer l'interface.</u>
</p>
<p>
Certaines parties du projet exigeant des droits <code>root</code>, elles
seront donc à réaliser dans une machine virtuelle. 
</p>
<p>
<u>Si vous rencontrez de sérieux problèmes de</u>
<u>quotas voir la <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/faq.html#quotas">FAQ</a></u>
<u><b>Dans tous les cas, évaluer votre place disponible</b></u>
</p>

<h2 id="toc10">2.1. Création de l'interface</h2>

<p>
En vous inspirant du code exemple de la 
<a href="https://git.kernel.org/?p=linux/kernel/git/torvalds/linux.git;a=blob;f=Documentation/networking/tuntap.txt">documentation</a>
(section 3), écrire une bibliothèque <code>iftun</code> qui crée une telle
interface virtuelle. 
Le nom de l'interface pourra être défini à l'exécution.
Prendre <code>"tun0"</code> pour les tests de cette partie.
</p>

<pre>  
    #include &lt;linux/if.h&gt;
    #include &lt;linux/if_tun.h&gt;
  
    int tun_alloc(char *dev)
    {
        struct ifreq ifr;
        int fd, err;
  
        if( (fd = open("/dev/net/tun", O_RDWR)) &lt; 0 )
          {
  	  perror("création tun");
            exit(1);
          }
  
        memset(&amp;ifr, 0, sizeof(ifr));
  
        /* Flags: IFF_TUN   - TUN device (no Ethernet headers) 
         *        IFF_TAP   - TAP device  
         *
         *        IFF_NO_PI - Do not provide packet information  
         */ 
        ifr.ifr_flags = IFF_TUN; 
        if( *dev )
           strncpy(ifr.ifr_name, dev, IFNAMSIZ);
  
        if( (err = ioctl(fd, TUNSETIFF, (void *) &amp;ifr)) &lt; 0 ){
           close(fd);
           return err;
        }
        strcpy(dev, ifr.ifr_name);
        return fd;
    } 
</pre>

<p>
<u><b>Indication :</b></u> On pourra compléter le
<a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/tunalloc.c">squelette C suivant</a>.
</p>
<p>
<b>NB</b> l'interface n'est pas persistante par défaut et disparaît dès
  que le processus l'ayant créée termine : pensez à mettre
  votre programme en pause avant de configurer <code>tun0</code>.
</p>

<h2 id="toc11">2.2. Configuration de l'interface</h2>

<ol>
<li>Configurer l'interface <code>tun0</code> avec l'adresse <code>172.16.2.1</code>, mettre
un masque adéquat. Ecrire un script <code>configure-tun.sh</code> reprenant vos
commandes de configuration.
</li>
<li><b>Routage :</b>
Suite à la <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/#reseau">disparition tragique de VM2</a>, faut-il modifier les
informations de routage sur VM1 ? ou sur VM1-6 ?
</li>
<li>Faire un <code>ping 172.16.2.1</code>. Donner la capture sur <code>tun0</code> (avec 
  <code>wireshark</code>).
  Que constatez-vous ? 
</li>
<li>Faire <code>ping 172.16.2.10</code>.   Que constatez-vous ? 
</li>
<li>Expliquez.
</li>
</ol>

<h2 id="toc12">2.3. Récupération des paquets</h2>

<p>
A la création de <code>tun0</code>, un descripteur de fichier est renvoyé (cf
l'exemple). C'est ce descripteur qui permet de lire ce qui est envoyé
à l'interface par un appel <code>read</code>.
</p>

<ol>
<li>Compléter la bibliothèque <code>iftun</code> avec une fonction avec deux
descripteurs de fichiers en paramètres <code>src</code> et <code>dst</code>, qui, étant
donné un descripteur <code>src</code> correspondant à une interface TUN,
recopie perpétuellement toutes les données lisibles sur <code>src</code> dans
le fichier décrit par <code>dst</code>.
<p></p>
</li>
<li>Tester avec <code>dst=1</code> (sortie standard). Comme ce qui est recopié
est du binaire, on filtrera la sortira du programme de test avec
<code>hexdump</code>. Par exemple en faisant

<pre>  VM$ test_iftun tun0 | hexdump -C
</pre>

<p></p>
</li>
<li>Refaire <code>ping6 172.16.2.1</code> puis <code>ping6 172.16.2.10</code>. Comparer et expliquer. 
  Quel type de trafic voyez-vous?
  Refaire une capture avec <code>wireshark</code>  dans le second cas et comparer
  avec ce qui est obtenu par votre programme <code>test_iftun</code>.
<p></p>
</li>
<li>A quoi sert l'option <code>IFF_NO_PI</code> ? 
  Que ce passe-t-il si vous ajoutez cette option lors de la création de
  l'interface ?
</li>
</ol>

<h1 id="ipv4">3. Un tunnel simple pour IPv4</h1>

<p>
Le but de cette partie est de créer un tunnel simple encapsulant un
trafic IPv4 dans des paquets TCP/IPv6. 
</p>
<p>
<img align="middle" src="./Projet Réseaux 2016_17 -- E. Godard_files/tunneld.png" border="0" alt="">
</p>

<h2 id="toc14">3.1. Redirection du trafic entrant</h2>

<p>
On utilisera par défaut le port <code>123</code>.
</p>
<p>
Dans cette partie, on créera une bibliothèque <code>extremite</code> qui gérera
le trafic entre extrémités du tunnel.
</p>

<ol>
<li>Ecrire une fonction <code>ext-out</code> qui crée un serveur écoutant sur le
  port <code>123</code>, et redirige les données reçues sur la sortie standard.
<p></p>
</li>
<li>Ecrire une fonction <code>ext-in</code> qui ouvre une connexion TCP avec l'autre
  extrémité du tunnel, puis lit le trafic provenant de <code>tun0</code> et le
  retransmet dans la socket.
</li>
</ol>

<ol>
<li>La commance <code>nc</code> (netcat) permet de transférer des données sur un
port réseau. 
Pour le support simple d'envoi IPv4 sur vos VMs,
il est possible d'installer éventuellement 
<code>netcat</code>.
L'option <code>-u</code> permet d'envoyer en UDP (puisque votre tunnel est unidirectionnel pour l'instant).
<p></p>
<pre>  VM$ nc -u fc00:1234.1 123 
</pre>

<p></p>
  <ol>
  <li>Mettre en place une extrémité <code>ext-in</code> et une extrémité <code>ext-out</code> sur deux VMs distinctes.
  </li>
  <li>Tester avec un "client" <code>ping 172.16.2.1.2</code> pour injecter du trafic comme dans la partie précédente. 
  </li>
  </ol>
</li>
</ol>

<h2 id="toc15">3.2. Redirection du trafic sortant</h2>

<ol>
<li>Compléter la fonction <code>ext-out</code> de la bibliothèque <code>extremite</code>
pour créer une extrémité qui 
retransmet le trafic provenant de la socket TCP dans le <code>tun0</code> local.
</li>
<li>Que devrait-il se passer alors pour ce trafic ?
  <b>Indication :</b> Que se passe-t-il lorsque l'on écrit dans le fichier correspondant à (au descripteur de) <code>tun0</code>?
</li>
<li>Vérifier avec l'un de vos paquets capturés dans le cas précédent. 
  Pensez à le modifier éventuellement (avec un éditeur hexadécimal)
  pour que cela corresponde à tous <b>vos</b> paramètres réseau. 
</li>
<li>Proposer des tests de connectivité. Tester et vérifier ! 
</li>
</ol>

<p>
<b>Indication :</b> Les commandes <code>nc</code>/<code>nc6</code> 
(netcat) permet également de transférer le contenu
d'un fichier sur un port réseau 
</p>

<pre>  VM$ nc6 IPDEST 123 &lt; fichier.bin
</pre>

<p>
<b>Indication :</b> Que se passe-t-il si le paquet est modifié sans modifier le CRC? Comment pourrait-on calculer le nouveau CRC ?
</p>
<p>
<b>Indication :</b> Vous pouvez également utiliser comme
données à écrire le <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/icmp2.bin">fichier suivant</a>. 
</p>

<h2 id="toc16">3.3. Intégration Finale du Tunnel</h2>

<ol>
<li>Compléter la bibliothèque pour pouvoir avoir un flux bidirectionnel
<p></p>
</li>
<li>Assurez-vous que les communications sont bien asynchrones.
</li>
</ol>

<h2 id="toc17">3.4. Mise en place du tunnel entre VM1-6 et VM3-6 : Schémas</h2>

<p>
On veut utiliser VM1-6 et VM3-6
pour pouvoir faire un tunnel entre LAN3 et
LAN4.
</p>

<ul>
<li>Compléter le <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/tunneld.svg">schéma simplifié</a> en expliquant <b>en détail</b> le 
parcours complet d'un paquet.
</li>
</ul>

<h2 id="toc18">3.5. Mise en place du tunnel entre VM1 et VM3 : Système</h2>

<ol>
<li>Créer un exécutable <code>tunnel46d</code> qui, en s'appuyant sur la
bibliothèque <code>extremite</code> crée un service offrant un tunnel TCP
bidirectionnel.
<p></p>
Cet exécutable lira sa configuration dans un fichier de la forme
suivante:
<pre>  # interface tun
  tun=tun0
  # adresse locale 
  inip=
  inport=
  options=
  # adresse distante
  outip=
  outport=
</pre>

<p></p>
Il pourra appeler le script de configuration réseau avec ces
paramètres une fois que l'interface est créée. Il est également
possible de faire des appels systèmes directs avec <code>ioctl</code>.
</li>
</ol>

<ol>
<li>Tester en configurant et lançant <code>tunnel64d</code> sur deux
VMs différentes.
<p></p>
</li>
<li>Comparer le trafic direct et celui passant par le tunnel.
</li>
</ol>

<h1 id="toc19">4. Validation Fonctionnelle</h1>

<p>
Il s'agit des tests minimaux à mettre en oeuvre pour valider
votre tunnel.
</p>

<h2 id="toc20">4.1. Configuration</h2>

<p>
Sur VM1-6, VM1,VM2-6,VM3,VM3-6, afficher les paramètres réseaux significatifs avec <code>ip addr</code> et <code>ip route</code>.
</p>

<h2 id="toc21">4.2. Couche 3</h2>

<p>
Depuis VM1, effectuer <code>ping6 172.16.2.183</code>.
Proposer éventuellement d'autre tests au niveau "Réseau".
</p>

<h2 id="toc22">4.3. Couche 4</h2>

<p>
Depuis VM1, créer un fichier "msg.txt" puis l'envoyer sur le service <code>echo</code> de VM3.
</p>

<pre>  VM1$ echo "Test" &gt; msg.txt
  VM1$ nc 172.16.2.183  VOTREPORTECHO &lt; msg.txt
</pre>

<h2 id="toc23">4.4. Couche 4 : bande passante</h2>

<p>
Afin de tester les performances réseaux, nous allons utiliser l'utilitaire
<code>iperf3</code>, qui permet de tester les performances d'une connexion.
</p>
<p>
Ce banc d'essai fonctionne en mode client/serveur, lancer le  serveur sur VM3
</p>

<pre>  VM3$ iperf3 -s
</pre>

<p>
Tester avec un petit, un moyen, un gros et un très gros tampon.
</p>

<pre>  VM1-6$ iperf3  -c 172.16.2.183 -n 1 -l 10
  VM1-6$ iperf3  -c 172.16.2.183 -n 1 -l 2K
  VM1-6$ iperf3  -c 172.16.2.183 -n 1 -l 128K
  VM1-6$ iperf3  -c 172.16.2.183 -n 1 -l 1M
</pre>

<h2 id="toc24">4.5. Couche 4 : facultatif</h2>

<p>
Proposer éventuellement d'autres tests afin de valider votre système.
</p>
<p>
<b>Indication :</b> En consultant notamment la documentation de <code>iperf3</code>,
on pourra s'intéreser à l'évolution de la bande passante au cours du temps,
à la gestion de la congestion, à la fragmentation, au MTU,
à la gestion des TTL, etc...
</p>

<h1 id="toc25">5. Améliorations</h1>

<p>
Implémenter au moins l'une de ces améliorations.
Deux améliorations sont à réaliser pour les trinômes de 4.
</p>

<h2 id="toc26">5.1. Configuration <tt>ansible</tt></h2>

<p>
Peut-on mettre en place la gestion du tunnel via <code>ansible</code>.
Quelles seraient les difficultés ? Proposer une solution et la mettre
en oeuvre.
</p>

<h2 id="toc27">5.2. Une amélioration simple</h2>

<p>
Il est possible d'<b>ajouter</b> en tête du paquet la taille de celui-ci
<i>sur deux octets</i> avant de l'envoyer dans le tunnel.
A la sortie du tunnel, cette information est utilisée pour attendre
tous les octets avant de les envoyer à l'interface virtuelle.
</p>

<ol>
<li>Compléter la bibliothèque <code>traitement</code> en ajoutant des méthodes
<code>taillentete_in</code> et <code>taillentête_out</code> permettant de mettre en
place ce prétraitement.
</li>
<li>La taille du paquet étant donné dans l'entête IP, écrire un
traitement <code>tailleauto</code> qui <b>n'ajoute pas</b> d'entête mais tient
compte de la taille par lecture du champ taille de l'entête du paquet
encapsulé. 
</li>
</ol>

<h2 id="toc28">5.3. Fragmentation et Réassemblage</h2>

<p>
Au lieu de mettre en attente les données comme dans le cas précédent,
on peut gérer explicitement la fragmentation au niveau des extrémités
du tunnel.
</p>

<ol>
<li>Ajoute des méthodes <code>frag_in</code> et <code>frag_out</code> permettant de mettre
en place un tel traitement.
</li>
</ol>

<h2 id="toc29">5.4. Tunnels entre VMs</h2>

<ol>
<li>Comment faire pour réaliser un tunnel entre VMs situés sur des hôtes
 différents ?
<p></p>
<b>Indication :</b> Penser à utiliser la redirection de port de <code>virtualbox</code>.
<p></p>
</li>
<li>Faire une démonstration de communication par un tel tunnel entre un
serveur echov6 et un client echov6 situé sur des VMs qui n'hébergent
pas <code>tunnel64d</code>.
</li>
</ol>

<h1 id="toc30">6. FAQ</h1>

<h2 id="toc31">6.1. Comment ouvrir un shell en root ?</h2>

<p>
Utiliser <code>sudo -s</code>
</p>

<h2 id="toc32">6.2. Le JRE est différent entre la machine hôte et la VM</h2>

<p>
Oui, notez qu'il est possible de spécifier la version cible à la compilation.
</p>

<pre>  $ javac -source 1.7 -target 1.7 -bootclasspath /usr/lib/jvm/java-7-openjdk-amd64/jre/lib/rt.jar code.java
</pre>

<h2 id="java">6.3. Java, ce n'est pas la fête pour les appels système</h2>

<p>
Le code java est compilé vers une machine virtuelle JAVA, ce qui rend
le code portable d'un système d'exploitation à l'autre.
Mais si vous souhaitez faire des appels système, il faudra sans doute
utiliser <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jni/">JNI</a>
pour accéder directement au système d'exploitation sous-jacent.
</p>
<p>
Notez également que dans tous les cas, vous pouvez faire les appels
système en C, puis, par un appel <code>exec()</code>, passer la main 
(et surtout les descripteurs de fichiers) à un programme écrit dans un
autre langage.
</p>

<h2 id="toc34">6.4. On n'a pas encore vu de serveur en java</h2>

<p>
En voici un exemple de <a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/ens/reseaux/projet/EchoServeur.java">serveur echo</a>.
</p>

<h2 id="toc35">6.5. Les interfaces TUN n'apparaissent pas dans l'interface graphique</h2>

<p>
Il faudra utiliser <code>ip link show</code> pour les voir.
Vous pouvez les configurer via <code>ansible</code>
</p>

<h2 id="toc36">6.6. Comment envoyer un seul paquet ICMP avec <tt>ping</tt> ?</h2>

<p>
Utiliser l'option <code>-c</code> : <code>ping -c 1 123.45.67.89</code>
</p>

<h2 id="toc37">6.7. Les paquets lus sur <tt>tun0</tt> sont incomplets ?</h2>

<p>
Attention le paramètre <code>MTU</code> de votre interface (en général 1500)
doit correspondre à votre propre traitement : si vous utilisez un
tampon intermédiaire de taille inférieure au <code>MTU</code>, les données
<i>manquées</i> seront perdues et vos paquets tronqués (c'est le même
pĥénomène pour des sockets en mode datagramme).
</p>
<p>
<b>Attention</b> la <code>MTU</code> choisie doit être compatible avec IPv6.
</p>

<h2 id="toc38">6.8. J'ai mis en place la redirection de ports sur <tt>virtualbox</tt> mais le <tt>ping/ping6</tt> ne fonctionne pas ?</h2>

<p>
La redirection de port pour passer un NAT/PAT ne fonctionne
que pour le protocole TCP.
</p>

<!-- xhtml code generated by txt2tags 2.6. (http://txt2tags.org) -->
<!-- cmdline: txt2tags -C config.t2t -C parametres.local.conf.t2t -C ../../parametres.conf.t2t -T ../../template.htm -t xhtml -\-toc -o projet.html projet.t2t -->
    </div>
    <div id="bas">
      <div id="email"> 
	<a href="http://pageperso.lif.univ-mrs.fr/~emmanuel.godard/">E. Godard</a> 
      </div>
      <div id="modif">Dernière modification le vendredi 25 novembre 2016</div>
      &nbsp;
      <div id="validhtml">
	[<a href="http://validator.w3.org/check/referer">xhtml</a>]
      </div> 
    </div>
    
    <!-- xhtml code generated by txt2tags 2.6b (http://txt2tags.sf.net) -->
  


</body></html>